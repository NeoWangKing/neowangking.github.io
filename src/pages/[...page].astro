---
import type { GetStaticPaths } from 'astro'
import MainPageLayout from '@/layouts/MainPageLayout.astro'
import PostList from '@/components/post/PostList.astro'
import PostPagination from '@/components/post/PostPagination.astro'
import { getSortedPosts } from '@/utils/content'
import appConfig from '@/config.json'
import SectionBlock from '@/components/SectionBlock.astro'
import type { CollectionEntry } from 'astro:content'

export const getStaticPaths = (async () => {
  // 
  const sortedPosts = await getSortedPosts()
  // 每一页显示的文章数量
  const { perPage } = appConfig.posts
  // 计算总共的页数
  const totalPage = Math.ceil(sortedPosts.length / perPage)

  const paths = Array.from({ length: totalPage }).map((_, i) => { 
    // i 就是 0 ~ totalPage-1
    // 截取得到第 i+1 页的文章
    const data = sortedPosts.slice(i * perPage, (i + 1) * perPage)
    // 返回当前的页码 i+1 以及本页所有的文章 data
    const props = { currentPage: i + 1, totalPage, data }
    
    // 如果 i 为 0 则表示为首页（页码 1），i 不为 0 则返回 `page/${i + 1}`
    const params = {
      page: i === 0 ? undefined : `page/${i + 1}`,
    }
    return { params, props }
  })

  return paths
}) satisfies GetStaticPaths

interface Props {
  currentPage: number
  totalPage: number
  data: CollectionEntry<'posts'>[]
}

const { currentPage, totalPage, data } = Astro.props

//获取页面的跳转链接
const getPageUrl = (page: number) => {
  if (page === 1) return '/'
  return `/page/${page}`
}
---

<MainPageLayout currentPage={currentPage}>
  <!-- 列出所有文章 -->
  <div class="min-w-0">
    <SectionBlock title="最新发布">
      <PostList posts={data} />
      {
        // 如果总页数大于 1 就显示翻页组件
        totalPage > 1 && (
          <PostPagination current={currentPage} total={totalPage} getPageUrl={getPageUrl} />
        )
      }
    </SectionBlock>
  </div>
</MainPageLayout>
